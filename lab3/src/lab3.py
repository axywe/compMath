import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import root
import time


# Defining the system of ODEs
def system_of_odes(t, y):
    theta, omega = y
    dtheta_dt = omega
    domega_dt = np.cos(t) - 0.1 * omega - np.sin(theta)
    return np.array([dtheta_dt, domega_dt])

# Runge-Kutta 4th order method
def runge_kutta(x_0, t_n, f, h):
    N = int(t_n / h)
    t = np.linspace(0, t_n, N + 1)
    y = np.zeros((N + 1, len(x_0)))
    y[0] = x_0
    for i in range(N):
        k1 = h * f(t[i], y[i])
        k2 = h * f(t[i] + h/2, y[i] + k1/2)
        k3 = h * f(t[i] + h/2, y[i] + k2/2)
        k4 = h * f(t[i] + h, y[i] + k3)
        y[i + 1] = y[i] + (k1 + 2 * k2 + 2 * k3 + k4) / 6
    return t, y

# Adams-Moulton method 
def adams_moulton(x_0, t_n, f, h):
    t_initial, y_initial = runge_kutta(x_0, 4 * h, f, h)
    N = int(t_n / h)
    t = np.linspace(0, t_n, N + 1)
    y = np.zeros((N + 1, len(x_0)))
    y[:len(t_initial)] = y_initial
    for i in range(3, N):
        func_to_solve = lambda y_next: y_next - y[i] - h * (9 * f(t[i+1], y_next) + 19 * f(t[i], y[i]) - 5 * f(t[i-1], y[i-1]) + f(t[i-2], y[i-2])) / 24
        y_next = root(func_to_solve, y[i]).x
        y[i + 1] = y_next
    return t, y


# Milne-Simpson method (predictor-corrector)
def milne_simpson(x_0, t_n, f, h):
    t_initial, y_initial = runge_kutta(x_0, 4 * h, f, h)
    N = int(t_n / h)
    t = np.linspace(0, t_n, N + 1)
    y = np.zeros((N + 1, len(x_0)))
    y[:5] = y_initial
    for i in range(4, N):
        predictor = y[i-3] + 4 * h / 3 * (2 * f(t[i-2], y[i-2]) - f(t[i-1], y[i-1]) + 2 * f(t[i], y[i]))
        corrector = y[i-1] + h / 3 * (f(t[i-1], y[i-1]) + 4 * f(t[i], y[i]) + f(t[i+1], predictor))
        y[i + 1] = corrector
    return t, y


t_n = 100 
h = 0.1 
np.random.seed(3) 
initial_conditions = np.random.uniform(1.85, 2.1, 15)


# Trajectories using each method
trajectories_rk = [runge_kutta([0.0, omega_0], t_n, system_of_odes, h) for omega_0 in initial_conditions]
trajectories_am = [adams_moulton([0.0, omega_0], t_n, system_of_odes, h) for omega_0 in initial_conditions]
trajectories_ms = [milne_simpson([0.0, omega_0], t_n, system_of_odes, h) for omega_0 in initial_conditions]

# Plotting the trajectories
fig, axes = plt.subplots(3, 1, figsize=(12, 18))

# Runge-Kutta Plots
for t, y in trajectories_rk:
    axes[0].plot(t, y[:, 0], label=f'ω₀={y[0, 1]:.2f}')
axes[0].set_title('Метод Рунге-Кутта')
axes[0].set_xlabel('t')
axes[0].set_ylabel('θ(t)')
axes[0].grid(True)
axes[0].legend()

# Adams-Moulton Plots
for t, y in trajectories_am:
    axes[1].plot(t, y[:, 0], label=f'ω₀={y[0, 1]:.2f}')
axes[1].set_title('Метод Адамса-Моултона')
axes[1].set_xlabel('t')
axes[1].set_ylabel('θ(t)')
axes[1].grid(True)
axes[1].legend()

# Milne-Simpson Plots
for t, y in trajectories_ms:
    axes[2].plot(t, y[:, 0], label=f'ω₀={y[0, 1]:.2f}')
axes[2].set_title('Метод Милна-Симпсона')
axes[2].set_xlabel('t')
axes[2].set_ylabel('θ(t)')
axes[2].grid(True)
axes[2].legend()

plt.tight_layout()
plt.show()
fig.savefig("methods.pdf", bbox_inches='tight')

t_n = 100 
initial_conditions = [0.0, 1.85]  # θ(0) = 0, dθ/dt(0) = 1.85

fig, axes = plt.subplots(3, 1, figsize=(12, 18))

h_values = np.linspace(0.5, 1.2, 10)
trajectories_rk_test = [runge_kutta(initial_conditions, t_n, system_of_odes, h) for h in h_values]
# Рунге-Кутта
for i, (t, y) in enumerate(trajectories_rk_test):
    axes[0].plot(t, np.pi * y[:, 0], label=f'h={h_values[i]:.2f}')
axes[0].set_title('Метод Рунге-Кутта')
axes[0].set_xlabel('t')
axes[0].set_ylabel('θ')
axes[0].grid(True)
axes[0].legend()
h_values = np.linspace(0.5, 1.2, 10)
trajectories_am_test = [adams_moulton(initial_conditions, t_n, system_of_odes, h) for h in h_values]

# Адамс-Моултон
for i, (t, y) in enumerate(trajectories_am_test):
    axes[1].plot(t, np.pi * y[:, 0], label=f'h={h_values[i]:.2f}')
axes[1].set_title('Метод Адамса-Моултона')
axes[1].set_xlabel('t')
axes[1].set_ylabel('θ')
axes[1].grid(True)
axes[1].legend()

h_values = np.linspace(0.2, 0.35, 10)
trajectories_ms_test = [milne_simpson(initial_conditions, t_n, system_of_odes, h) for h in h_values]
# Милн-Симпсон
for i, (t, y) in enumerate(trajectories_ms_test):
    axes[2].plot(t, np.pi * y[:, 0], label=f'h={h_values[i]:.2f}')
axes[2].set_title('Метод Милна-Симпсона')
axes[2].set_xlabel('t')
axes[2].set_ylabel('θ')
axes[2].grid(True)
axes[2].legend()
# axes[2].set_xlim(95, 100)



plt.tight_layout()
plt.show()
fig.savefig("methods_by_h_pi_theta.pdf", bbox_inches='tight')


fig_ms, ax_ms = plt.subplots(figsize=(12, 6))

for i, (t, y) in enumerate(trajectories_ms_test):
    ax_ms.plot(t, np.pi * y[:, 0], label=f'h={h_values[i]:.2f}')

ax_ms.set_title('Метод Милна-Симпсона')
ax_ms.set_xlabel('t')
ax_ms.set_ylabel('θ')
ax_ms.grid(True)
ax_ms.legend()

# Ограничение оси x
ax_ms.set_xlim(97.5, 100)

plt.show()

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
# ПРОДВИНУТАЯ ЧАСТЬ
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################

# Функция для построения фазовых траекторий
def plot_phase_trajectories(trajectories, title, index):
    fig = plt.figure(figsize=(14, 6))
    for t, y in trajectories:
        plt.plot(y[:, 0], y[:, 1], label=f'ω₀={y[0, 1]:.2f}')
    plt.title(title)
    plt.xlabel('θ')
    plt.ylabel('dθ/dt')
    plt.grid(True)
    plt.legend()
    plt.show()
    fig.savefig(f"graph{index}.pdf", bbox_inches='tight')


# Построение фазовых траекторий для разных начальных условий
plot_phase_trajectories(trajectories_rk, "Фазовые траектории (Метод Рунге-Кутта)", 1)
plot_phase_trajectories(trajectories_am, "Фазовые траектории (Метод Адамса-Моултона)", 2)
plot_phase_trajectories(trajectories_ms, "Фазовые траектории (Метод Милна-Симпсона)", 3)

# Сравнение методов для одного начального условия
initial_condition = [0.0, 1.98]
trajectories = [
    ("Метод Рунге-Кутта", runge_kutta(initial_condition, t_n, system_of_odes, h)),
    ("Метод Адамса-Моултона", adams_moulton(initial_condition, t_n, system_of_odes, h)),
    ("Метод Милна-Симпсона", milne_simpson(initial_condition, t_n, system_of_odes, h))
]

# Создание графика
fig = plt.figure(figsize=(14, 6))
for method_name, (t, y) in trajectories:
    plt.plot(y[:, 0], y[:, 1], label=f'{method_name}')
plt.title("Сравнение методов для одного начального условия")
plt.xlabel('θ')
plt.ylabel('dθ/dt')
plt.grid(True)
plt.legend()
plt.show()

# Сохранение графика в файл
fig.savefig(f"graphsravn.pdf", bbox_inches='tight')

# Оценка времени вычислений
methods = [runge_kutta, adams_moulton, milne_simpson]
time_results = {}
for method in methods:
    start_time = time.time()
    method(initial_condition, t_n, system_of_odes, h)
    time_results[method.__name__] = time.time() - start_time

print("Время вычислений для каждого метода:", time_results)